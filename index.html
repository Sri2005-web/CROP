<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crop Disease Detector</title>
    <style>
        /* (Styles are the same as the previous version, keeping them here for completeness) */
        :root { --primary-color: #4CAF50; --secondary-color: #8BC34A; --danger-color: #f44336; --warning-color: #ff9800; --info-color: #2196F3; --dark-bg: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --border-color: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--dark-bg); color: var(--text-color); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 90%; max-width: 1200px; background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); overflow: hidden; }
        .login-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .login-container h1 { color: var(--primary-color); margin-bottom: 20px; }
        .login-form { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }
        .login-form input { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #2a2a2a; color: var(--text-color); font-size: 16px; }
        .login-form button { padding: 12px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .login-form button:hover { background-color: var(--secondary-color); }
        .app-container { display: none; padding: 20px; }
        .app-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .app-header h1 { color: var(--primary-color); }
        .logout-btn { padding: 8px 16px; border: 1px solid var(--danger-color); background-color: transparent; color: var(--danger-color); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background-color: var(--danger-color); color: white; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        .detection-area, .results-area, .history-area { background-color: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .detection-area h2, .results-area h2, .history-area h2 { margin-top: 0; color: var(--secondary-color); }
        .video-container, .preview-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; background: #000; border-radius: 8px; overflow: hidden; }
        #webcam, #preview-canvas { width: 100%; height: auto; display: block; }
        .controls { display: flex; gap: 15px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-secondary { background-color: #555; color: white; }
        .btn-secondary:hover { background-color: #666; }
        .results-card { margin-top: 20px; padding: 20px; background-color: var(--card-bg); border-radius: 8px; display: none; }
        .results-card.not-found { border-color: var(--warning-color); }
        .results-card.found { border-color: var(--primary-color); }
        .results-card.not-plant { border-color: var(--info-color); }
        .results-card h3 { margin-top: 0; }
        .results-card.not-found h3 { color: var(--warning-color); }
        .results-card.found h3 { color: var(--primary-color); }
        .results-card.not-plant h3 { color: var(--info-color); }
        .results-card p { line-height: 1.6; }
        .confidence { font-weight: bold; font-size: 1.2em; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .history-table th { background-color: #333; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <!-- LOGIN PAGE -->
    <div id="login-page" class="login-container">
        <h1>üåæ AI Crop Disease Detector</h1>
        <p>Please log in or register to continue.</p>
        <form class="login-form" onsubmit="handleLogin(event)">
            <input type="text" id="username" placeholder="Username" required>
            <button type="submit">Login / Register</button>
        </form>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="app-page" class="app-container">
        <header class="app-header">
            <h1>üåæ AI Crop Disease Detector</h1>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </header>

        <main class="main-content">
            <!-- DETECTION SECTION -->
            <section class="detection-area">
                <h2>Scan Your Crop</h2>
                <div class="video-container">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="preview-canvas" style="display: none;"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="captureImage()">üì∏ Capture</button>
                    <label for="image-upload" class="btn btn-secondary">üìÅ Upload Image</label>
                    <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>
            </section>

            <!-- RESULTS & HISTORY SECTION -->
            <div>
                <!-- RESULTS AREA -->
                <section class="results-area">
                    <h2>Prediction Results</h2>
                    <div id="results-placeholder">
                        <p>Capture or upload an image to see the prediction.</p>
                    </div>
                    <div id="loader" class="loader" style="display: none;"></div>
                    <div id="results-card" class="results-card">
                        <!-- Results will be injected here by JS -->
                    </div>
                </section>

                <!-- HISTORY AREA -->
                <section class="history-area">
                    <h2>Prediction History</h2>
                    <p>Your past predictions are stored here for your reference.</p>
                    <table class="history-table">
                        <thead>
                        <tr>
                            <th>Prediction ID</th>
                            <th>Disease</th>
                            <th>Confidence</th>
                        </tr>
                        </thead>
                        <tbody id="history-tbody">
                        <!-- History rows will be injected here by JS -->
                        </tbody>
                    </table>
                </section>
            </div>
        </main>
    </div>
</div>

<!-- SCRIPT IS NOW HERE, AT THE END OF THE BODY -->
<script>
    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app-page');
    const webcamVideo = document.getElementById('webcam');
    const previewCanvas = document.getElementById('preview-canvas');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const loader = document.getElementById('loader');
    const resultsCard = document.getElementById('results-card');
    const historyTableBody = document.getElementById('history-tbody');

    // --- APPLICATION STATE ---
    let currentImageBlob = null;
    let stream = null;
    let currentUser = null; // Stores { id, username }

    // --- UPDATED LINE ---
    // This relative URL will work on both your local machine and the live server.
    const API_URL = '/api';

    // --- AUTHENTICATION ---
    function checkLoginStatus() {
        if (currentUser) {
            showApp();
        } else {
            showLogin();
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        try {
            let response = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            });
            let data = await response.json();

            if (!response.ok) {
                if (response.status === 401) {
                    console.log("User not found, registering...");
                    response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username })
                    });
                    data = await response.json();
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            }

            currentUser = { id: data.user_id, username: username };
            console.log('Logged in as:', currentUser);
            showApp();

        } catch (error) {
            console.error('Authentication error:', error);
            alert('An error occurred during login.');
        }
    }

    function handleLogout() {
        currentUser = null;
        showLogin();
    }

    function showLogin() {
        loginPage.style.display = 'flex';
        appPage.style.display = 'none';
        stopWebcam();
    }

    function showApp() {
        loginPage.style.display = 'none';
        appPage.style.display = 'block';
        startWebcam();
        displayHistory();
    }

    // --- WEBCAM & IMAGE HANDLING ---
    async function startWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcamVideo.srcObject = stream;
        } catch (err) {
            console.error("Error accessing webcam: ", err);
            alert("Unable to access webcam. Please ensure you have granted camera permissions.");
        }
    }

    function stopWebcam() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            webcamVideo.srcObject = null;
        }
    }

    // --- UPDATED FUNCTION ---
    function captureImage() {
        const context = previewCanvas.getContext('2d');
        previewCanvas.width = webcamVideo.videoWidth;
        previewCanvas.height = webcamVideo.videoHeight;
        context.drawImage(webcamVideo, 0, 0, previewCanvas.width, previewCanvas.height);

        webcamVideo.style.display = 'none';
        previewCanvas.style.display = 'block';

        // UPDATED: Moved predictDisease() inside the toBlob callback
        previewCanvas.toBlob(blob => {
            currentImageBlob = blob;
            predictDisease(); // Now it only runs AFTER the blob is ready
        }, 'image/jpeg');
    }

    // --- UPDATED FUNCTION ---
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            currentImageBlob = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const context = previewCanvas.getContext('2d');
                    previewCanvas.width = img.width;
                    previewCanvas.height = img.height;
                    context.drawImage(img, 0, 0);
                    webcamVideo.style.display = 'none';
                    previewCanvas.style.display = 'block';

                    // UPDATED: Moved predictDisease() inside the img.onload callback
                    predictDisease(); // Now it only runs AFTER the image is drawn for preview
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // --- CORE PREDICTION LOGIC ---
    async function predictDisease() {
        if (!currentImageBlob || !currentUser) return;

        resultsPlaceholder.style.display = 'none';
        resultsCard.style.display = 'none';
        loader.style.display = 'block';

        const formData = new FormData();
        formData.append('image', currentImageBlob);
        formData.append('user_id', currentUser.id);

        try {
            const response = await fetch(`${API_URL}/predict`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (response.status === 400 && result.error) {
                displayError(result.error);
            } else if (!response.ok) {
                throw new Error(result.error || 'Prediction failed');
            } else {
                displayResults(result);
                displayHistory();
            }

        } catch (error) {
            console.error('Prediction error:', error);
            displayError(`Prediction failed: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    // --- DISPLAY FUNCTIONS ---

    function displayResults(result) {
        resultsCard.className = 'results-card found';
        resultsCard.innerHTML = `
                <h3>${result.disease}</h3>
                <p><strong>Confidence Level:</strong> <span class="confidence">${result.confidence}</span></p>
                <p><strong>Recommended Action:</strong></p>
                <p>${result.treatment}</p>
            `;
        resultsCard.style.display = 'block';
    }

    function displayError(message) {
        resultsCard.className = 'results-card not-found';
        resultsCard.innerHTML = `
            <h3>‚ö†Ô∏è Invalid Image</h3>
            <p>${message}</p>
        `;
        resultsCard.style.display = 'block';
    }

    // --- UPDATED FUNCTION (Minor Performance Improvement) ---
    async function displayHistory() {
        if (!currentUser) return;
        try {
            const response = await fetch(`${API_URL}/history?user_id=${currentUser.id}`);
            const history = await response.json();

            historyTableBody.innerHTML = '';
            if (history.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No history yet.</td></tr>`;
                return;
            }

            // UPDATED: Build all rows in a single string before updating the DOM
            let historyRows = '';
            history.forEach(item => {
                historyRows += `<tr><td>${item.timestamp}</td><td>${item.disease}</td><td>${item.confidence}</td></tr>`;
            });
            historyTableBody.innerHTML = historyRows;

        } catch (error) {
            console.error('Failed to fetch history:', error);
        }
    }

    // --- INITIALIZE APP ON LOAD ---
    window.onload = checkLoginStatus;

</script>

</body>
</html>
